<!DOCTYPE html>
<title>Code</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
<link rel="stylesheet" href="/css/main.css">
<style type="text/css" media="screen">
  #editor {
    position: absolute;
    top: 50px;
    right: 0;
    bottom: 0;
    left: 0;
  }

  #message {
    position: fixed;
    right: 20px;
    bottom: 0;
    z-index: 100;
    display: none;
  }
  .btn {
    margin: 8px 0;
  }
</style>
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-2">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">Code In The Dark</a>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-2">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="#!" data-toggle="modal" data-target="#video-modal">Video</a></li>
        <li><button id="save-button" class="btn btn-danger btn-sm" href="#!">Save</button></li>
      </ul>
    </div>
  </div>
</nav>
<div id="editor"></div>
<div id="message"></div>

  <!-- Modal -->
<div class="modal fade" id="video-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Video Preview</h4>
      </div>
      <div class="modal-body">
        <iframe width="100%" height="315" src="https://www.youtube.com/embed/y-yzL5zJVno" frameborder="0" allowfullscreen></iframe>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.7/socket.io.min.js"></script>
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.2/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.2/mode-html.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.2/theme-monokai.js"></script>
<script>
(function () {
  var editor = ace.edit("editor");
  var socket = io();
  var oldData;
  $('#editor').css('fontSize', '20px');
  editor.setTheme("ace/theme/monokai");
  editor.getSession().setMode("ace/mode/html");
  editor.setHighlightActiveLine(true);
  editor.getSession().setUseWorker(false);
  editor.setBehavioursEnabled(false);
  editor.commands.addCommand({
    name: 'save',
    bindKey: {win: 'Ctrl-S',  mac: 'Command-S'},
    exec: function(editor) {
      store();
    },
    readOnly: false
  });
  socket.on('save response', function(data) {
    console.log(data.success);
    if(data.success) {
      $('#message').html('save success');
      $('#message').addClass('alert alert-success');
    } else {
      $('#message').html('save failed. try again :")');
      $('#message').addClass('alert alert-danger');
    }
    $('#message').fadeIn(500).delay(1000).fadeOut(500);
  });
  $('#save-button').click(store);
  socket.on('competition end', function() {
    editor.setReadOnly(true);
    $('#save-button').click(function(){});
  });
  function store(data) {
    var data = {
      userId: '{{ user.id }}',
      code: editor.getValue()
    };
    if(JSON.stringify(oldData) !== JSON.stringify(data)) {
      socket.emit('code save', data);
      oldData = data;
    }
  }

})();
</script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ==" crossorigin="anonymous"></script>
